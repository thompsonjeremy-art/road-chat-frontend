<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Road Issue Reporter</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121820; --muted:#94a3b8; --text:#e5eef7;
      --line:#1e293b; --chip:#1f2937; --chip-hover:#2b3542; --radius:16px;
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f8fafc; --card:#ffffff; --text:#0b1220; --muted:#4b5563; --line:#e5e7eb; --chip:#f2f4f8; --chip-hover:#e5e7eb}
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    *{box-sizing:border-box}

    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100svh}

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));padding:.6rem .9rem;border-bottom:1px solid var(--line)}
    .bar{display:flex;align-items:center;gap:.6rem}
    .brand{font-weight:700}
    .spacer{flex:1}
    .iconbtn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);border-radius:12px;padding:.45rem .6rem}

    .panel{display:none;padding:.6rem .9rem;border-bottom:1px solid var(--line);background:var(--card)}
    .panel.open{display:block}
    .rowc{display:flex;gap:.5rem;align-items:center}
    input[type=url]{flex:1;min-width:0;background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:.55rem .7rem}

    main{overflow:auto;padding:.8rem .9rem 8.5rem}
    .chat{display:flex;flex-direction:column;gap:.6rem}
    .row{display:flex;gap:.6rem;align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{max-width:min(82%,36rem);padding:.65rem .8rem;border-radius:18px;background:var(--card);border:1px solid var(--line)}
    .row.me .bubble{background:#1f2937}
    .thumb{display:block;max-width:min(82vw,320px);border-radius:14px;border:1px solid var(--line)}
    .bot{opacity:.92}

    /* typing indicator */
    .typing{display:inline-flex;gap:.25rem;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:.8;animation:blink 1.3s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.2} 40%{opacity:1}}

    .composer{position:fixed;left:0;right:0;bottom:0;z-index:10;padding:.6rem .9rem calc(env(safe-area-inset-bottom) + .6rem);background:linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,0));border-top:1px solid var(--line)}
    .cbar{display:flex;gap:.5rem;align-items:flex-end}
    .input{flex:1;background:var(--card);border:1px dashed var(--line);border-radius:16px;padding:.55rem .7rem;min-height:48px}
    .input:focus-within{border-style:solid}
    textarea{background:transparent;border:0;outline:0;resize:none;width:100%;max-height:32svh;color:var(--text);font:16px/1.35 inherit}
    .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);border-radius:14px;padding:.7rem .9rem;min-height:44px;min-width:44px}
    .primary{background:#2563eb;border:0}

    .chips{display:flex;flex-wrap:wrap;gap:.45rem;margin:.5rem .05rem 0}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:.5rem .75rem;font-size:.93rem}
    .chip:active,.chip:hover{background:var(--chip-hover)}

    .hint{color:var(--muted);font-size:.85rem;margin-top:.25rem}
    @media (max-width:480px){ .brand{font-size:1rem} .bubble{max-width:90%} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="bar">
        <div class="brand">üõ£Ô∏è Road Issue Reporter</div>
        <div class="spacer"></div>
        <button id="gear" class="iconbtn" title="Settings">‚öôÔ∏è</button>
        <button id="exportBtn" class="iconbtn" title="Download CSV">‚¨áÔ∏è</button>
      </div>
      <div id="panel" class="panel">
        <div class="rowc">
          <input id="backend" type="url" placeholder="Backend URL (e.g. https://road-chat-backend.onrender.com)" />
          <button id="saveUrl" class="iconbtn">Save</button>
        </div>
      </div>
    </header>

    <main><div id="chat" class="chat"></div></main>

    <div class="composer">
      <div class="cbar">
        <div id="dropzone" class="input"><textarea id="msg" rows="1" placeholder="Describe the issue or drop/paste a photo‚Ä¶"></textarea></div>
        <input id="file" type="file" accept="image/*" capture="environment" hidden />
        <button id="attach" class="btn" title="Attach photo">üì∑</button>
        <button id="send" class="btn primary">Send</button>
      </div>
      <div id="chips" class="chips"></div>
      <div class="hint">Tip: paste/drag an image or tap üì∑. Chips appear only when follow-ups are needed.</div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const chat = $('#chat'), input = $('#msg'), fileInput = $('#file'), dropzone = $('#dropzone'), chips = $('#chips');

    function sid(){ let v = localStorage.getItem('sid'); if(!v){ v = crypto.randomUUID(); localStorage.setItem('sid',v); } return v; }
    function backend(v){ if(v!==undefined){ localStorage.setItem('backend',v); return v; } return localStorage.getItem('backend')||''; }

    function row(role, html){
      const r = document.createElement('div'); r.className = 'row '+role;
      const b = document.createElement('div'); b.className = 'bubble '+(role==='bot'?'bot':'');
      b.innerHTML = html; r.appendChild(b); chat.appendChild(r); chat.scrollTop = chat.scrollHeight; return b;
    }
    function imgRow(role, blobUrl){
      const r = document.createElement('div'); r.className = 'row '+role;
      const b = document.createElement('div'); b.className = 'bubble';
      const img = document.createElement('img'); img.src = blobUrl; img.className = 'thumb'; img.alt = 'attached photo';
      b.appendChild(img); r.appendChild(b); chat.appendChild(r); chat.scrollTop = chat.scrollHeight; return img;
    }

    // typing indicator
    function typingOn(){
      const r = document.createElement('div'); r.className = 'row bot'; r.id = 'typing';
      const b = document.createElement('div'); b.className = 'bubble';
      b.innerHTML = `<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      r.appendChild(b); chat.appendChild(r); chat.scrollTop = chat.scrollHeight;
    }
    function typingOff(){
      const t = document.getElementById('typing'); if(t) t.remove();
    }

    // contextual chips (only when needed)
    function setChipsFor(message){
      chips.innerHTML = '';
      if(!message) return;
      const m = message.toLowerCase();
      const wantsSeverity = /severity/.test(m);
      const wantsLane     = /(lane.*blocked|blocked.*lane|whether a lane)/.test(m);
      const wantsType     = /(problem type|issue type|what best describes the issue)/.test(m);
      const wantsLocation = /(road name.*milepost|milepost|intersection)/.test(m) || /use my location/.test(m);

      const add = (label, handler) => {
        const btn = document.createElement('button'); btn.className='chip'; btn.textContent = label;
        btn.onclick = ()=>{ handler(); chips.innerHTML=''; }; // hide after tap
        chips.appendChild(btn);
      };

      if(wantsLane){ add('Lane: Yes', ()=>send({text:'lane blocked yes'})); add('Lane: No', ()=>send({text:'lane not blocked'})); }
      if(wantsSeverity){ add('Severity: Minor', ()=>send({text:'severity minor'})); add('Severity: Moderate', ()=>send({text:'severity moderate'})); add('Severity: Severe', ()=>send({text:'severity severe'})); }
      if(wantsType){ ['pothole','cracking','shoulder drop','guardrail','sign','drainage','debris','snow ice'].forEach(t=> add(t, ()=>send({text:t}))); }
      if(wantsLocation){ add('Use my location', onUseLocation); }
    }

    // geolocation
    function onUseLocation(){
      if(!navigator.geolocation){ row('bot','Geolocation not supported on this device.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        row('me', `üìç ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`);
        send({coords:{lat:latitude, lon:longitude}});
      }, err=>{
        row('bot', `Couldn‚Äôt get location (${err.code}). You can provide the road & milepost instead.`);
      }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }

    // input sizing
    function autosize(){ input.style.height='auto'; input.style.height=Math.min(input.scrollHeight,240)+'px'; }
    input.addEventListener('input', autosize);

    // paste image
    document.addEventListener('paste', (e)=>{
      const it = Array.from(e.clipboardData?.items||[]).find(x=>x.type?.startsWith('image/'));
      if(it){ const file = it.getAsFile(); const url = URL.createObjectURL(file); imgRow('me',url); send({file}); e.preventDefault(); }
    });
    // drag & drop
    ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev, e=>{e.preventDefault(); dropzone.style.borderColor='#60a5fa';}));
    ['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev, e=>{e.preventDefault(); dropzone.style.borderColor='var(--line)';}));
    dropzone.addEventListener('drop', e=>{ const f = e.dataTransfer?.files?.[0]; if(f?.type.startsWith('image/')){ const u=URL.createObjectURL(f); imgRow('me',u); send({file:f}); } });

    // buttons
    $('#attach').onclick = ()=>fileInput.click();
    fileInput.onchange   = ()=>{ const f = fileInput.files?.[0]; if(!f) return; const u=URL.createObjectURL(f); imgRow('me',u); send({file:f}); fileInput.value=''; };
    $('#send').onclick   = ()=>{ const v=input.value.trim(); if(!v) return; row('me',v); send({text:v}); input.value=''; autosize(); };

    // settings
    const panel = $('#panel');
    $('#gear').onclick   = ()=> panel.classList.toggle('open');
    $('#saveUrl').onclick= ()=>{ const v=$('#backend').value.trim(); if(!v) return; backend(v); row('bot','Saved backend URL.'); panel.classList.remove('open'); };
    $('#backend').value = backend();

    // export
    $('#exportBtn').onclick = ()=>{ const url=backend(); if(!url){ row('bot','Set backend URL in ‚öôÔ∏è first.'); return; } window.open(url.replace(/\/$/,'')+'/export.csv','_blank'); };

    // send() with typing indicator + slight delay for natural feel
    async function send({text, file, coords}){
      const url = backend();
      if(!url){ row('bot','Please set your backend URL in ‚öôÔ∏è Settings.'); return; }
      try{
        const fd = new FormData();
        fd.append('session_id', sid());
        if(text!==undefined) fd.append('text', text);
        if(file) fd.append('photo', file, file.name || 'photo.jpg');
        if(coords?.lat && coords?.lon){ fd.append('lat', String(coords.lat)); fd.append('lon', String(coords.lon)); }

        typingOn();
        const res = await fetch(url.replace(/\/$/,'')+'/chat', { method:'POST', body: fd });
        const data = await res.json();
        await new Promise(r=>setTimeout(r, 650)); // gentle pause
        typingOff();

        const reply = (data.reply || '').replaceAll('\n','<br/>');
        const bubble = row('bot', reply);

        setChipsFor(bubble.textContent.toLowerCase()); // show only relevant chips
      }catch(e){
        typingOff();
        console.error(e);
        row('bot','‚ö†Ô∏è Could not reach backend. Check URL & CORS.');
      }
    }

    // initial message
    row('bot','Hi! Send a photo or describe the issue. I‚Äôll only ask what I need, one step at a time.');
  </script>
</body>
</html>