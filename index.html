<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Road Issue Reporter</title>
  <style>
    :root{
      --bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--brand:#0b6;--card:#ffffff;--ring:#cbd5e1;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{position:sticky;top:0;background:var(--card);z-index:10;box-shadow:0 1px 8px rgba(2,6,23,.06)}
    .bar{max-width:960px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .title{font-weight:700}
    .wrap{max-width:960px;margin:20px auto;padding:0 16px}

    /* Settings card */
    .settings{background:var(--card);border-radius:14px;padding:12px 12px;display:grid;grid-template-columns:1fr 180px;gap:8px;align-items:center;border:1px solid var(--ring)}
    .settings input{width:100%;padding:10px;border:1px solid var(--ring);border-radius:10px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0;border-radius:999px;padding:6px 10px;font-size:12px}

    /* Chat */
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 1px 8px rgba(2,6,23,.05)}
    #chat{height:56vh;min-height:360px;overflow:auto;padding:16px;scroll-behavior:smooth}
    .row{display:flex;gap:10px;margin:8px 0}
    .me{justify-content:flex-end}
    .bubble{max-width:72%;padding:10px 12px;border-radius:14px;border:1px solid var(--ring);background:#f8fafc}
    .me .bubble{background:#dcfce7;border-color:#a7f3d0}
    .who{font-size:12px;color:var(--muted);margin-bottom:4px}
    .imgbubble{padding:6px}
    .imgbubble img{max-width:260px;border-radius:12px;display:block}

    /* Composer */
    .composer{border-top:1px solid var(--ring);padding:10px;background:linear-gradient(180deg, rgba(246,247,251,.0), rgba(246,247,251,1));border-radius:0 0 16px 16px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .box{position:relative;flex:1;display:flex;align-items:center}
    .input{flex:1;padding:12px 44px 12px 12px;border:1px solid var(--ring);border-radius:12px}
    .attach{position:absolute;right:6px;top:50%;transform:translateY(-50%);display:flex;gap:6px}
    .btn{border:0;border-radius:12px;background:var(--brand);color:#fff;padding:12px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#e5e7eb;color:#111}
    .danger{background:var(--danger)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* Drag-n-drop */
    .drop{position:absolute;inset:0;border:2px dashed var(--brand);border-radius:12px;display:none;align-items:center;justify-content:center;background:rgba(16,185,129,.05);color:#065f46;font-weight:600}
    .box.drag .drop{display:flex}

    /* Quick replies */
    .quick{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chip:hover{background:#f8fafc}

    footer{padding:18px 0;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="dot" aria-hidden="true"></div>
      <div class="title">Road Issue Reporter</div>
      <span class="pill" style="margin-left:auto">PoC</span>
    </div>
  </header>

  <div class="wrap">
    <div class="settings card" style="margin-bottom:12px">
      <label for="backend" class="who">Backend URL</label>
      <input id="backend" placeholder="https://road-chat-backend.onrender.com"/>
    </div>

    <div class="card" id="chatcard">
      <div id="chat" aria-live="polite" aria-label="Conversation"></div>
      <div class="composer">
        <div class="toolbar">
          <div class="box" id="dropbox">
            <input id="text" class="input" placeholder="Type a message…  (or paste/drag a photo)" autocomplete="off"/>
            <div class="attach">
              <button class="btn ghost" id="choose">Attach</button>
              <button class="btn" id="send">Send</button>
            </div>
            <div class="drop" id="drophelp">Drop photo to attach</div>
            <input type="file" id="file" accept="image/*" capture="environment" hidden>
          </div>
        </div>
        <div class="hint">Tip: drag & drop, paste (Ctrl/Cmd+V), or tap <strong>Attach</strong> to add a photo. We’ll ask only a couple of quick follow‑ups.</div>
        <div class="quick" id="quick"></div>
      </div>
    </div>

    <footer>
      <a href="#" id="reset">reset session</a>
    </footer>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const backendInput = document.getElementById('backend');
    const text = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    const chooseBtn = document.getElementById('choose');
    const file = document.getElementById('file');
    const dropbox = document.getElementById('dropbox');
    const quick = document.getElementById('quick');

    function sid(){
      let v = localStorage.getItem('session_id');
      if(!v){ v = 'sess_' + Math.random().toString(36).slice(2); localStorage.setItem('session_id', v); }
      return v;
    }
    function backend(){
      let url = localStorage.getItem('backend_url') || 'https://road-chat-backend.onrender.com';
      backendInput.value = url; return url;
    }
    function saveBackend(){ const v = backendInput.value.trim(); if(v) localStorage.setItem('backend_url', v); }
    backendInput.addEventListener('change', saveBackend); backendInput.addEventListener('blur', saveBackend);

    function row(role, html){
      const r = document.createElement('div'); r.className = 'row '+role;
      const b = document.createElement('div'); b.className = 'bubble'; b.innerHTML = html;
      r.appendChild(b); chat.appendChild(r); chat.scrollTop = chat.scrollHeight;
      return b;
    }
    function imgRow(role, src){
      const r = document.createElement('div'); r.className = 'row '+role;
      const b = document.createElement('div'); b.className = 'bubble imgbubble';
      const img = document.createElement('img'); img.src = src; b.appendChild(img);
      r.appendChild(b); chat.appendChild(r); chat.scrollTop = chat.scrollHeight;
    }

    function setQuick(options){
      quick.innerHTML = '';
      options.forEach(opt => {
        const c = document.createElement('button');
        c.className = 'chip'; c.textContent = opt.label; c.title = opt.hint || '';
        c.addEventListener('click', () => opt.onClick());
        quick.appendChild(c);
      });
    }

    function clearQuick(){ quick.innerHTML = ''; }

    function parseGuess(text){
      // Extract label from: "I think this looks like: pothole." (fallback best-effort)
      const m = /looks like:\s*([\w_\-]+)/i.exec(text || '');
      return m ? m[1].toLowerCase() : null;
    }

    async function send({textValue, fileObj}){
      const url = backend();
      const form = new FormData();
      form.append('session_id', sid());
      if(textValue) form.append('text', textValue);
      if(fileObj) form.append('photo', fileObj, fileObj.name || 'photo.jpg');
      sendBtn.disabled = true; chooseBtn.disabled = true;
      try{
        const res = await fetch(url + '/chat', { method:'POST', body: form });
        const data = await res.json();
        row('bot', escapeHtml(data.reply || '(no reply)'));

        // Show quick replies based on context
        const guess = parseGuess(data.reply || '');
        if(guess){
          setQuick([
            {label:'Yes', onClick: ()=> { clearQuick(); row('me','Yes'); send({textValue:'yes'}); }},
            {label:'No', onClick: ()=> { clearQuick(); row('me','No'); send({textValue:'no'}); }},
            {label:'Change type…', hint:'Pick a different type', onClick: ()=> showTypePicker()} 
          ]);
        } else if(/How severe is it\?/i.test(data.reply||'')){
          setQuick([
            {label:'Minor', onClick: ()=> { clearQuick(); row('me','minor'); send({textValue:'minor'}); }},
            {label:'Moderate', onClick: ()=> { clearQuick(); row('me','moderate'); send({textValue:'moderate'}); }},
            {label:'Severe', onClick: ()=> { clearQuick(); row('me','severe'); send({textValue:'severe'}); }}
          ]);
        } else if(/What road/i.test(data.reply||'')){
          setQuick([
            {label:'Type location…', onClick: ()=> text.focus()}
          ]);
        } else {
          clearQuick();
        }
      }catch(e){
        row('bot', `<span style="color:var(--danger)">Error contacting backend: ${escapeHtml(e.message)}</span>`);
      }finally{
        sendBtn.disabled = false; chooseBtn.disabled = false;
      }
    }

    function showTypePicker(){
      const types = ['pothole','cracking','shoulder_drop','guardrail','sign','drainage','debris','snow_ice'];
      setQuick(types.map(t=>({label:t.replace('_',' '), onClick: ()=>{ clearQuick(); row('me', t.replace('_',' ')); send({textValue:t}); }})));
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    // --- UX: Attach flow ---
    chooseBtn.addEventListener('click', ()=> file.click());
    file.addEventListener('change', ()=>{
      const f = file.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> imgRow('me', reader.result);
      reader.readAsDataURL(f);
      clearQuick();
      send({ fileObj: f });
      file.value = '';
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(ev=> dropbox.addEventListener(ev, e=>{ e.preventDefault(); dropbox.classList.add('drag'); }));
    ;['dragleave','dragend','drop'].forEach(ev=> dropbox.addEventListener(ev, e=>{ e.preventDefault(); dropbox.classList.remove('drag'); }));
    dropbox.addEventListener('drop', e=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return;
      const reader = new FileReader(); reader.onload=()=> imgRow('me', reader.result); reader.readAsDataURL(f);
      clearQuick();
      send({ fileObj: f });
    });

    // Paste image or text
    document.addEventListener('paste', (e)=>{
      if(e.clipboardData){
        const items = e.clipboardData.items;
        for(const it of items){
          if(it.type && it.type.startsWith('image/')){
            const f = it.getAsFile();
            const reader = new FileReader(); reader.onload=()=> imgRow('me', reader.result); reader.readAsDataURL(f);
            clearQuick();
            send({ fileObj: f });
            return;
          }
        }
      }
      // otherwise, let text paste into input
    });

    // Send text
    sendBtn.addEventListener('click', ()=> {
      const val = text.value.trim(); if(!val) return;
      row('me', escapeHtml(val)); text.value = ''; clearQuick();
      send({ textValue: val });
    });
    text.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); }});

    // Reset session
    document.getElementById('reset').addEventListener('click', (e)=>{
      e.preventDefault(); localStorage.removeItem('session_id'); chat.innerHTML=''; clearQuick();
      row('bot', 'Session reset. Attach a photo or type a message to begin.');
    });

    // Init
    backend();
    row('bot', 'Hi! Attach a photo (drag, paste, or tap Attach) or describe the road issue. I’ll ask just a couple of follow‑ups.');
  </script>
</body>
</html>
